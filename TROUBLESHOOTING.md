# AI Patch Application System - Troubleshooting Guide

This document describes the issues encountered when building an AI-powered code modification system and their solutions.

---

## 1. Diff Problem: Patch Application Failures

### Initial Problem

When running `npm run test:apply`, patches generated by the AI executor agent failed with errors like:

```
❌ Failed: src/components/alerts/alerts.jsx → Patch failed: Unknown line 10 " "
```

**Root Causes Identified:**

1. **Incorrect Hunk Line Counts**: AI generated unified diffs with wrong line counts in `@@ -start,count +start,count @@` headers
   - Header said `@@ -1,5 +1,6 @@` (5 old lines, 6 new lines)
   - But the hunk included 50+ lines of context
   - The `diff` library requires exact line count matches

2. **Whitespace Mismatches**: LLMs convert tabs to spaces during generation
   - Original file used tabs: `\t` (0x09)
   - AI-generated diff used spaces: `  ` (0x20 0x20)
   - The `diff` library does byte-perfect matching and rejects mismatches

3. **One Giant Hunk**: AI included entire file instead of creating separate hunks for separate changes

### The Fix

Created a **3-strategy fallback system** in `src/utils/apply-patch-safe.ts`:

```typescript
export function applyPatchWithFallback(
    originalContent: string,
    diff: string,
    filePath?: string
): { success: boolean; content?: string; error?: string } {
    
    // Strategy 1: Try original diff with diff library
    try {
        const result = applyPatch(originalContent, diff);
        if (result !== false) {
            return { success: true, content: result };
        }
    } catch (err: any) {
        console.log(`✗ Failed: ${err.message}`);
    }
    
    // Strategy 2: Fix AI-generated diff issues
    try {
        const fixedDiff = fixDiff(diff, originalContent);
        const result = applyPatch(originalContent, fixedDiff);
        if (result !== false) {
            return { success: true, content: result };
        }
    } catch (err: any) {
        console.log(`✗ Failed: ${err.message}`);
    }
    
    // Strategy 3: Use patch command (more forgiving)
    if (filePath) {
        try {
            // Create temp directory with file
            const tmpDir = `/tmp/patch-${Date.now()}`;
            fs.mkdirSync(tmpDir, { recursive: true });
            
            const tmpFile = path.join(tmpDir, path.basename(filePath));
            const tmpDiff = path.join(tmpDir, 'changes.patch');
            
            fs.writeFileSync(tmpFile, originalContent, 'utf8');
            fs.writeFileSync(tmpDiff, fixedDiff, 'utf8');
            
            // Apply with patch command (--ignore-whitespace is key!)
            execSync(`patch --ignore-whitespace "${tmpFile}" < "${tmpDiff}"`, {
                cwd: tmpDir,
                stdio: 'pipe'
            });
            
            const result = fs.readFileSync(tmpFile, 'utf8');
            fs.rmSync(tmpDir, { recursive: true });
            
            return { success: true, content: result };
        } catch (err: any) {
            console.log(`✗ Failed: ${err.message}`);
        }
    }
    
    return {
        success: false,
        error: "Patch rejected - unable to apply with any strategy"
    };
}
```

**Supporting Utility** (`src/utils/fix-ai-diff.ts`):

```typescript
export function fixDiff(diff: string, originalContent: string): string {
    const { useTabs, tabSize } = detectIndentation(originalContent);
    
    // Step 1: Convert whitespace if needed
    let fixedDiff = useTabs ? convertSpacesToTabs(diff, tabSize) : diff;
    
    // Step 2: Fix hunk headers to match actual line counts
    const lines = fixedDiff.split('\n');
    const result: string[] = [];
    
    // Parse each hunk and recalculate line counts
    // ... (implementation details in the file)
    
    return result.join('\n');
}
```

### Before Fix

```bash
$ npm run test:apply

❌ Failed: src/components/alerts/alerts.jsx → Patch failed: Unknown line 10 " "
```

**Why it failed:**
- Diff library couldn't parse the malformed hunk
- Whitespace (tabs vs spaces) didn't match
- Line counts were wrong

### After Fix

```bash
$ npm run test:apply

=== Patch Application ===
Strategy 1: diff library with original...
✗ Failed: Unknown line 10 " "
Strategy 2: diff library with fixes...
✗ Failed: Unknown line 15 "\tconst { remove } = useAlert()"
Strategy 3: patch command...
✓ Success with patch command
✔ Updated: src/components/alerts/alerts.jsx
✨ Patch operation complete.
```

**Result:** Patches now apply successfully! The system gracefully falls back to more forgiving tools.

### Additional Fix: Backup Cleanup

**Problem:** `.backup` files were created but never removed.

**Before:**
```typescript
// Create backup
const backupPath = abs + ".backup";
fs.writeFileSync(backupPath, original, "utf8");

// Apply patch...

// ❌ Backup never cleaned up!
```

**After:**
```typescript
// Create backup
const backupPath = abs + ".backup";
fs.writeFileSync(backupPath, original, "utf8");

// Apply patch...
if (patchResult.success) {
    fs.writeFileSync(abs, patchResult.content, "utf8");
    
    // ✅ Clean up backup on success
    try {
        fs.unlinkSync(backupPath);
    } catch (err) {
        console.warn(`⚠️  Could not remove backup file: ${backupPath}`);
    }
} else {
    // Keep backup on failure for debugging
    console.warn(`⚠️  Backup preserved at: ${backupPath}`);
}
```

---

## 2. Hallucination Problem: AI Not Implementing All Steps

### Initial Problem

When given multi-step instructions like:

```json
{
  "steps": [
    "Add console.log('TEST EXECUTOR') after imports",
    "Replace inline style with Tailwind utility classes for z-index"
  ]
}
```

The AI would:
- ✅ Complete step 1 (add console.log)
- ❌ Skip step 2 or make phantom changes (whitespace-only modifications)
- ✅ **Claim** in the summary it did both: "Added console log and replaced inline styles" (HALLUCINATION)

**Actual Diff Generated:**

```diff
@@ -5,6 +5,7 @@
 import { Alert } from './alert'
 
 const alertConfig = { tension: 125, friction: 20, precision: 0.1 }
+console.log('TEST EXECUTOR')
 
 export function Alerts() {
@@ -37,7 +38,7 @@
 	return (
-		<div className="fixed top-2 right-2" style={{ zIndex: 1400 }}>
+		<div className="fixed top-2 right-2" style={{ zIndex: 1400 }}>
```

Notice line 15: The style prop is **IDENTICAL** - just phantom whitespace change!

**Root Cause:** `gpt-4o-mini` model has limited instruction-following capability for complex multi-step diff generation tasks.

### The Fix: Upgrade Model

**Before** (`src/agents/executor-agent.ts`):

```typescript
export async function runExecutorAgent(
    params: ExecutorAgentParams
): Promise<ExecutorOutput> {
    const prompt = buildExecutorPrompt({...});
    
    const response = await client.chat.completions.create({
        model: "gpt-4o-mini",  // ❌ Not capable enough
        messages: [{ role: "user", content: prompt }],
        temperature: 0,
    });
    
    return parseJsonSafe<ExecutorOutput>(response.choices[0].message?.content ?? "{}");
}
```

**After**:

```typescript
export async function runExecutorAgent(
    params: ExecutorAgentParams
): Promise<ExecutorOutput> {
    const prompt = buildExecutorPrompt({...});
    
    console.log("Calling OpenAI API...");
    const response = await client.chat.completions.create({
        model: "gpt-4o",  // ✅ More capable model
        messages: [{ role: "user", content: prompt }],
        temperature: 0,
    }, {
        timeout: 120000  // 2 minute timeout
    });
    console.log("✓ Received response from OpenAI");
    
    return parseJsonSafe<ExecutorOutput>(response.choices[0].message?.content ?? "{}");
}
```

### Before Fix (gpt-4o-mini)

**Input:**
```json
{
  "steps": [
    "Add console.log('my first interaction') after imports",
    "Replace inline style with Tailwind utility classes for z-index"
  ]
}
```

**Output Diff:**
```diff
+console.log('my first interaction')  ✅ Step 1: Done

// Line with style={{ zIndex: 1400 }} unchanged  ❌ Step 2: Skipped
```

**AI Summary:** "Added console log and replaced inline styles" ← **LIE/HALLUCINATION**

### After Fix (gpt-4o)

**Input:** (same)

**Output Diff:**
```diff
+console.log('my first interaction')  ✅ Step 1: Done

-<div className="fixed top-2 right-2" style={{ zIndex: 1400 }}>
+<div className="fixed top-2 right-2 z-[1400]">  ✅ Step 2: Done
```

**AI Summary:** "Added console log and replaced inline styles" ← **TRUE**

---

## Alternative Solutions Considered

### Option: Hybrid Model Approach

Use cheap model first, upgrade on failure:

```typescript
export async function runExecutorAgent(params: ExecutorAgentParams) {
    // Try mini first
    try {
        const output = await executeWithModel(params, "gpt-4o-mini");
        
        const expectedSteps = JSON.parse(params.planJson).implementation?.steps?.length || 0;
        const actualChanges = countChangesInDiff(output);
        
        if (actualChanges >= expectedSteps) {
            return output;  // Success with cheap model
        }
    } catch {}
    
    // Fallback to better model
    return executeWithModel(params, "gpt-4o");
}
```

### Option: One Step at a Time

Process each step individually:

```typescript
const steps = plan.implementation?.steps || [];
let currentContent = originalFileContent;

for (const step of steps) {
    const singleStepPlan = { ...plan, implementation: { steps: [step] } };
    const result = await executeOnce({ ...params, planJson: JSON.stringify(singleStepPlan) });
    
    // Apply result to content for next iteration
    currentContent = applyDiff(currentContent, result);
}
```

---

## Summary

| Problem | Root Cause | Solution |
|---------|-----------|----------|
| **Patch Application Failures** | Incorrect line counts, whitespace mismatches, strict byte-matching | 3-strategy fallback system with `patch` command |
| **Backup Files Not Cleaned** | Missing cleanup code | Add `fs.unlinkSync(backupPath)` on success |
| **AI Skips Steps (Hallucination)** | gpt-4o-mini limited capability | Upgrade to gpt-4o model |

**Key Lessons Learned:**

1. **LLMs have inherent limitations** with exact formatting - build robust fallbacks
2. **Don't trust AI summaries** - validate actual output programmatically
3. **Model selection matters** - complex tasks need more capable models
4. **Unix tools are forgiving** - `patch` command handles issues the `diff` library rejects

**Final Result:** ✅ System now reliably generates and applies code modifications with proper validation and fallback strategies.

---

## 3. New Issue: AI Generating Full-File Diffs with Wrong Hunk Headers

### Current Problem (2024-12-14)

When running `npm run test:execution` followed by `npm run test:apply`, patches fail to apply with:

```
Strategy 1: diff library with original...
✗ Failed: Removed line count did not match for hunk at line 1
Strategy 2: diff library with fixes...
✗ Failed: [similar error]
Strategy 3: patch command...
✗ Failed: Command failed: patch --ignore-whitespace
❌ Failed: src/components/alerts/alerts.jsx → Patch rejected - unable to apply with any strategy
```

**Root Cause:**

The AI (gpt-4.1-mini) is generating a diff with a **hunk header that doesn't match the actual content**:

```diff
@@ -1,14 +1,16 @@
-import { useMemo } from 'react'
-import { useAlertsState } from '@/components/alerts/contexts/alerts-context'
-import { useAlert } from '@/modules/shared/hooks'
-import { animated, useTransition } from '@react-spring/web'
-import { Alert } from './alert'
-
-const alertConfig = { tension: 125, friction: 20, precision: 0.1 }
-const alertTimeout = 5000
-
-export function Alerts() {
- 	const { remove } = useAlert()
- 	const {
- 		state: { alerts },
- 	} = useAlertsState()
[... continues for 50+ lines ...]
```

**The Problem:**
- Header says: `@@ -1,14 +1,16 @@` (remove 14 lines, add 16 lines)
- Actual content: Removes 50+ lines and adds 50+ lines
- This is a **full-file replacement** disguised as a small change

### Why This Happens

1. **AI doesn't understand unified diff format** - Despite detailed instructions in the prompt, the model generates a single giant hunk instead of:
   - Multiple small hunks for separate changes
   - Proper context lines (only 3 before/after each change)
   - Accurate line counts in hunk headers

2. **Model limitation** - `gpt-4.1-mini` may not have enough capability to:
   - Count lines accurately
   - Generate multiple hunks for changes in different parts of the file
   - Follow the strict unified diff format

3. **Prompt doesn't enforce structure** - The current prompt explains the format but doesn't:
   - Show examples of files with multiple changes
   - Explicitly forbid full-file diffs
   - Validate output before returning

### Analysis of the Generated Diff

**What the AI should have generated** (2 separate hunks):

```diff
--- src/components/alerts/alerts.jsx
+++ src/components/alerts/alerts.jsx
@@ -5,6 +5,8 @@
 import { Alert } from './alert'
 
+console.log('my first interaction')
+
 const alertConfig = { tension: 125, friction: 20, precision: 0.1 }
 const alertTimeout = 5000
 
@@ -37,7 +39,7 @@
 	})
 
 	return (
-		<div className="fixed top-2 right-2" style={{ zIndex: 1400 }}>
+		<div className="fixed top-2 right-2 z-[1400]">
 			{transitions(({ life, ...style }, alert) => {
 				return (
```

**What the AI actually generated:**
- One giant hunk with wrong line counts
- Entire file content included
- Makes it impossible for patch tools to apply

### Potential Solutions

#### Option 1: Upgrade Model (Again)
Try `gpt-4o` instead of `gpt-4.1-mini`:

```typescript
// src/agents/executor-agent.ts
const response = await client.chat.completions.create({
    model: "gpt-4o",  // More capable model
    messages: [{ role: "user", content: prompt }],
    temperature: 0,
});
```

**Pros:** May generate better diffs  
**Cons:** More expensive, not guaranteed to fix the issue

#### Option 2: Post-Process AI Output
Add a validation/fixing step that:
1. Parses the AI-generated diff
2. Detects full-file replacements
3. Regenerates proper hunks by comparing old vs new content

```typescript
function fixFullFileDiff(diff: string, originalContent: string): string {
    // Parse diff to detect if it's a full-file replacement
    // If yes, use a proper diff library to generate correct hunks
    // Return fixed diff
}
```

**Pros:** Fixes the issue at the source  
**Cons:** Complex to implement, may introduce new bugs

#### Option 3: Use Structured Output with Line Numbers
Change the prompt to request line-based changes instead of diffs:

```json
{
  "modifications": [
    {
      "path": "src/file.tsx",
      "changes": [
        { "type": "insert", "afterLine": 6, "content": "console.log('test')" },
        { "type": "replace", "line": 38, "oldContent": "...", "newContent": "..." }
      ]
    }
  ]
}
```

Then generate the unified diff programmatically.

**Pros:** More reliable, easier for AI to generate  
**Cons:** Requires rewriting executor agent and prompt

#### Option 4: Fix Hunk Headers Programmatically
Enhance `fix-ai-diff.ts` to handle full-file diffs:

```typescript
export function fixDiff(diff: string, originalContent: string): string {
    // Detect if hunk claims small change but has full file
    // If detected, use diff library to generate proper diff from scratch
    const lines = diff.split('\n');
    const removedLines = lines.filter(l => l.startsWith('-')).map(l => l.substring(1));
    const addedLines = lines.filter(l => l.startsWith('+')).map(l => l.substring(1));
    
    // If this looks like a full file replacement, regenerate diff
    if (removedLines.length > 20 && addedLines.length > 20) {
        return generateProperDiff(
            removedLines.join('\n'),
            addedLines.join('\n')
        );
    }
    
    // Otherwise, just fix line counts as before
    return fixLineCountsOnly(diff);
}
```

**Pros:** Fixes the immediate issue  
**Cons:** Heuristic-based, may not work for all cases

### Recommended Approach

**Short-term:** Implement Option 4 (fix hunk headers programmatically)  
**Long-term:** Consider Option 3 (structured output) for more reliability

### ✅ Solution Implemented (2024-12-14)

**Implemented:** Option 4 + Model Upgrade

1. **Enhanced `fix-ai-diff.ts`** with full-file diff detection and regeneration:
   - Detects when a diff has one giant hunk with >70% of file content
   - Extracts old and new content from the malformed diff
   - Uses `createTwoFilesPatch()` from `diff` library to regenerate proper hunks
   - Continues with existing whitespace and line count fixes

2. **Upgraded model** from `gpt-4.1-mini` to `gpt-4o`:
   - More capable model reduces frequency of malformed diffs
   - Better instruction following for unified diff format

3. **Enhanced prompt** with explicit warning:
   - Added clear warning against full-file diffs
   - Emphasized requirement for multiple small hunks
   - Provided concrete example of when to split hunks

**Result:**
```bash
$ npm run test:apply

=== Patch Application ===
Strategy 1: diff library with original...
✗ Failed: Removed line count did not match for hunk at line 1
Strategy 2: diff library with fixes...
⚠️  Detected full-file diff, regenerating with proper hunks...
✓ Regenerated diff with proper hunks
✓ Success with diff library
✔ Updated: src/components/alerts/alerts.jsx
```

The system now:
- ✅ Detects full-file diffs automatically
- ✅ Regenerates them with proper hunks
- ✅ Applies patches successfully
- ✅ Uses better model to reduce issues at source

### Status

✅ **RESOLVED** - Patches now apply successfully with automatic fix for malformed diffs
